/*! ap-maps 2018-04-18 */

angular.module("ap-maps",["adminPanel"]),angular.module("ap-maps").directive("apMapPoint",["mapService","pointNormalizer","$rootScope","$timeout",function(c,m,s,n){return{restrict:"AE",require:"?ngModel",scope:{name:"@"},link:function(o,n,e,t){var l=!angular.isUndefined(e.readonly),a=this;function i(n){var e=m.normalize(n);a.point=e,null!==a.map&&(a.map.panTo(e),r(e))}function r(n){null!==a.marker&&(a.marker.remove(),a.marker=null),a.marker=L.marker([n.lat,n.lng]),a.marker.addTo(a.map)}function p(n){if(null!==a.map){var e=n.latlng;r(e);var l=m.denormalize(e);s.$broadcast("ap-map:pointpicker",o.name,l),null!==t&&t.$setViewValue(l)}}a.elemMap=n.find(".map"),o.height=c.height,a.map=null,a.marker=null,a.point=null,a.initPromise=c.init(a.elemMap[0]).then(function(n){a.map=n,l||a.map.on("click",p),null!==a.point&&(a.map.panTo(a.point),r(a.point))}),o.$on("apMap:showOnMapPoint",function(n,e,l){o.name===e&&null!==l&&i(l)}),null!==t&&o.$watch(function(){return t.$modelValue},function(n){n&&angular.isObject(n)&&i(n)});var u=o.$on("$destroy",function(){null!==a.map&&a.map.off("click",p),u()})},templateUrl:"directives/mapPoint/mapPoint.template.html"}}]),angular.module("ap-maps").directive("apMapPolygon",["mapService","polygonNormalizer","$rootScope","$timeout",function(s,d,g,f){return{restrict:"AE",require:"?ngModel",scope:{name:"@",fixedPolygons:"=?"},link:function(t,n,e,a){var i=this;function l(n){if(null!==i.map){var e=n.latlng,l=L.marker(e);l.addTo(i.map),l.on("click",o),i.markers.push(l),null===i.polyline?i.polyline=L.polyline([e],{color:"red"}).addTo(i.map):i.polyline.addLatLng(e)}}function o(n){for(var e=i.polyline.getLatLngs(),l=0;l<e.length;l++)if(e[l].equals(n.latlng)){e.splice(l,1);break}this.remove(),i.polyline.remove(),i.polyline=L.polyline(e,{color:"red"}).addTo(i.map)}function r(){for(var n=0;n<i.markers.length;n++)i.markers[n].off("click",o),i.markers[n].remove();i.markers=[],null!==i.polyline&&(i.polyline.remove(),i.polyline=null)}function p(){r(),console.log("self.polygon",i.polygon);for(var n=0;n<i.polygon.length;n++)i.polygon[n].remove();i.polygon=[]}function u(l){f(function(){var n=d.normalize(l);p(),i.polygon=[];for(var e=0;e<n.length;e++)i.polygon.push(L.polygon(n[e].latLngs,{color:"red"}).addTo(i.map))})}n.addClass("ap-map-polygon"),i.elemMap=n.find(".map"),t.height=s.height,i.map=null,i.markers=[],i.polyline=null,i.polygon=[],i.fixedPolygons=[],s.init(i.elemMap[0]).then(function(n){i.map=n,i.map.on("click",l)}),t.finish=function(){if(null!==i.polyline){var n=i.polyline.getLatLngs();r(),null===a&&i.polygon.push(L.polygon(n,{color:"red"}).addTo(i.map));for(var e=[],l=0;l<i.polygon.length;l++)e.push(i.polygon[l].getLatLngs()[0]);null!==a&&e.push(n);var o=d.denormalize(e);g.$broadcast("ap-map:polygonpicker",t.name,o),null!==a&&a.$setViewValue(o)}},t.clear=p;var c=t.$on("apMap:showOnMapPolygon",function(n,e,l){t.name===e&&null!==l&&u(l)});null!==a&&t.$watch(function(){return a.$modelValue},function(n){n&&angular.isObject(n)&&u(n)}),t.$watch("fixedPolygons",function(l){f(function(){var n,e=d.normalize(l);for(n=0;n<i.fixedPolygons.length;n++)i.fixedPolygons[n].remove();for(i.fixedPolygons=[],n=0;n<e.length;n++)i.fixedPolygons.push(L.polygon(e[n].latLngs,{color:"blue"}).addTo(i.map))})});var m=t.$on("$destroy",function(){null!==i.map&&i.map.off("click",l),c(),m()})},templateUrl:"directives/mapPolygon/mapPolygon.template.html"}}]),angular.module("ap-maps").directive("apMapPolyline",["mapService","linestringNormalizer","$rootScope","$timeout",function(s,d,g,f){return{restrict:"AE",require:"?ngModel",scope:{name:"@"},link:function(o,n,e,l){var t=this;n.addClass("ap-map-polyline");var a=n.find(".map");function i(n){if(null!==t.map){var e=n.latlng,l=L.marker(e);l.addTo(t.map),l.on("click",r),t.markers.push(l),null===t.polyline?t.polyline=L.polyline([e],{color:"red"}).addTo(t.map):t.polyline.addLatLng(e)}}function r(n){var e=t.polyline.getLatLngs();console.log(t.polyline);for(var l=0;l<e.length;l++)if(e[l].equals(n.latlng)){e.splice(l,1);break}this.remove(),t.polyline.remove(),t.polyline=L.polyline(e,{color:"red"}).addTo(t.map)}function p(){console.log(t.markers);for(var n=0;n<t.markers.length;n++)t.markers[n].off("click",r),t.markers[n].remove();t.markers=[],null!==t.polyline&&(t.polyline.remove(),t.polyline=null)}function u(n){f(function(){console.log(n.latLngs),p(),t.polyline=L.polyline(n.latLngs,{color:"red"}).addTo(t.map)})}o.height=s.height,t.map=null,t.markers=[],t.polyline=null,s.init(a[0]).then(function(n){t.map=n,t.map.on("click",i)}),o.finish=function(){if(null!==t.polyline){var n=t.polyline.getLatLngs();console.log(n),p(),t.polyline=L.polyline(n,{color:"red"}).addTo(t.map);var e=d.denormalize(n);g.$broadcast("ap-map:polylinepicker",o.name,n),null!==l&&l.$setViewValue(e)}},o.clear=p;var c=o.$on("apMap:showOnMapPolyline",function(n,e,l){console.log("entramos"),o.name===e&&null!==l&&u(l)});null!==l&&o.$watch(function(){return l.$modelValue},function(n){n&&angular.isObject(n)&&u(n)});var m=o.$on("$destroy",function(){null!==t.map&&t.map.off("click",i),c(),m()})},templateUrl:"directives/mapPolyline/mapPolyline.template.html"}}]),angular.module("ap-maps").directive("pointPicker",["$rootScope","$timeout",function(r,p){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(o,n,e,t){var l=this;o.model={latitud:null,longitud:null},l.point=null;var a=o.$on("ap-map:pointpicker",function(n,e,l){o.name===e&&t.$setViewValue(l)});o.clickBtn=function(){e.view?(r.$broadcast("apBox:show",e.view),p(function(){r.$broadcast("apMap:showOnMapPoint",o.name,l.point)})):r.$broadcast("apMap:showOnMapPoint",o.name,l.point)},o.$watch(function(){return t.$modelValue},function(n){n&&(l.point=n,o.model.latitud=n.y,o.model.longitud=n.x)});var i=o.$on("$destroy",function(){a(),i()})},templateUrl:"directives/pointPicker/pointPicker.template.html"}}]),angular.module("ap-maps").directive("polygonPicker",["$rootScope","$timeout",function(r,p){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(o,n,e,t){var l=this;l.polygon=null;var a=o.$on("ap-map:polygonpicker",function(n,e,l){o.name===e&&t.$setViewValue(l)});o.clickBtn=function(){e.view?(r.$broadcast("apBox:show",e.view),p(function(){r.$broadcast("apMap:showOnMapPolygon",o.name,l.polygon)})):r.$broadcast("apMap:showOnMapPolygon",o.name,l.polygon)},o.$watch(function(){return t.$modelValue},function(n){n&&(l.polygon=n)});var i=o.$on("$destroy",function(){a(),i()})},templateUrl:"directives/polygonPicker/polygonPicker.template.html"}}]),angular.module("ap-maps").directive("polylinePicker",["linestringNormalizer","$rootScope","$timeout",function(r,p,u){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(t,n,e,a){var l=null,o=t.$on("ap-map:polylinepicker",function(n,e,l){if(t.name===e){var o=r.denormalize(l);a.$setViewValue(o)}});t.clickBtn=function(){e.view?(p.$broadcast("apBox:show",e.view),console.log(l),u(function(){p.$broadcast("apMap:showOnMapPolyline",t.name,l)})):p.$broadcast("apMap:showOnMapPolyline",t.name,l)},t.$watch(function(){return a.$modelValue},function(n){n&&(l=r.normalize(n))});var i=t.$on("$destroy",function(){o(),i()})},templateUrl:"directives/polylinePicker/polylinePicker.template.html"}}]),angular.module("ap-maps").provider("MapsConfig",function(){var e=435,l=[-31.649913,-60.712328],o=13,t="OpenStreetMap.Mapnik";this.setMapHeight=function(n){return e=n,this},this.setCenter=function(n){return l=n,this},this.setZoom=function(n){return o=n,this},this.setTileProvider=function(n){return t=n,this},this.$get=[function(){return{defaultMapHeight:e,defaultCenter:l,defaultZoom:o,defaultTileProvider:t}}]}),angular.module("ap-maps").service("mapService",["MapsConfig","$timeout",function(l,n){return{height:l.defaultMapHeight,init:function(e){return n(function(){var n=L.map(e,{center:l.defaultCenter,zoom:l.defaultZoom},1e3);return L.tileLayer.provider(l.defaultTileProvider).addTo(n),n})}}}]),angular.module("ap-maps").service("linestringNormalizer",["pointNormalizer",function(t){this.normalize=function(n){var e,l,o=[];if(angular.isArray(n))for(e=0;e<n.length;e++)l=n[e],o.push(t.normalize(l));else if(n)for(e=0;e<n.points.length;e++)l=n.points[e],o.push(t.normalize(l));return{latLngs:o,closed:n.closed}},this.denormalize=function(n){for(var e=[],l=0;l<n.length;l++)e.push(t.denormalize(n[l]));return{points:e}}}]),angular.module("ap-maps").service("pointNormalizer",[function(){this.normalize=function(n){return angular.isArray(n)?L.latLng(n[1],n[0]):L.latLng(n.y,n.x)},this.denormalize=function(n){return{x:n.lng,y:n.lat}}}]),angular.module("ap-maps").service("polygonNormalizer",["linestringNormalizer",function(a){this.normalize=function(n){var e,l,o=[];if(angular.isArray(n))for(e=0;e<n.length;e++)l=n[e],o.push(a.normalize(l));else if(n)for(e=0;e<n.rings.length;e++)l=n.rings[e],o.push(a.normalize(l));return o},this.denormalize=function(n){for(var e=[],l=0;l<n.length;l++){var o=n[l],t=a.denormalize(o);t.points.push(t.points[0]),e.push(t)}return{rings:e}}}]),angular.module("adminPanel").run(["$templateCache",function(n){n.put("directives/mapPoint/mapPoint.template.html","<div class=map ng-style=\"{'height':height}\"></div>"),n.put("directives/mapPolygon/mapPolygon.template.html","<div class=map ng-style=\"{'height':height}\"></div><button type=button class=button ng-click=clear()>Limpiar</button><button type=button class=button ng-click=finish()>Terminar</button>"),n.put("directives/mapPolyline/mapPolyline.template.html","<div class=map ng-style=\"{'height':height}\"></div><button type=button class=button ng-click=clear()>Limpiar</button><button type=button class=button ng-click=finish()>Terminar</button>"),n.put("directives/pointPicker/pointPicker.template.html",'<div class=row><div class="columns small-12 large-6"><label>Latitud <input type=text ng-value=model.latitud readonly></label></div><div class="columns small-12 large-6"><label>Longitud <input type=text ng-value=model.longitud readonly></label></div><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver Punto en Mapa</button></div></div>'),n.put("directives/polygonPicker/polygonPicker.template.html",'<div class=row><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver en Mapa</button></div></div>'),n.put("directives/polylinePicker/polylinePicker.template.html",'<div class=row><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver en Mapa</button></div></div>')}]);