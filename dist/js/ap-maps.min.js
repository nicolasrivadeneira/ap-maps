/*! ap-maps 2018-04-24 */

angular.module("ap-maps",["adminPanel"]),angular.module("ap-maps").directive("apMapPoint",["mapService","pointNormalizer","$rootScope","$timeout",function(c,s,m,n){return{restrict:"AE",require:"?ngModel",scope:{name:"@"},link:function(l,n,e,a){var o=!angular.isUndefined(e.readonly),t=this;function i(n){var e=s.normalize(n);t.point=e,null!==t.map&&(t.map.panTo(e),r(e))}function r(n){null!==t.marker&&(t.marker.remove(),t.marker=null),t.marker=L.marker([n.lat,n.lng]),t.marker.addTo(t.map)}function p(n){if(null!==t.map){var e=n.latlng;r(e);var o=s.denormalize(e);m.$broadcast("ap-map:pointpicker",l.name,o),null!==a&&a.$setViewValue(o)}}t.elemMap=n.find(".map"),l.height=c.height,t.map=null,t.marker=null,t.point=null,t.initPromise=c.init(t.elemMap[0]).then(function(n){t.map=n,o||t.map.on("click",p),null!==t.point&&(t.map.panTo(t.point),r(t.point))}),l.$on("apMap:showOnMapPoint",function(n,e,o){l.name===e&&null!==o&&i(o)}),null!==a&&l.$watch(function(){return a.$modelValue},function(n){n&&angular.isObject(n)&&i(n)});var u=l.$on("$destroy",function(){null!==t.map&&t.map.off("click",p),u()})},templateUrl:"directives/mapPoint/mapPoint.template.html"}}]),angular.module("ap-maps").directive("apMapPolygon",["mapService","polygonNormalizer","$rootScope","$timeout",function(m,d,g,f){return{restrict:"AE",require:"?ngModel",scope:{name:"@",fixedPolygons:"=?"},link:function(a,n,e,t){var i=this;function o(n){if(null!==i.map){var e=n.latlng,o=L.marker(e);o.addTo(i.map),o.on("click",l),i.markers.push(o),null===i.polyline?i.polyline=L.polyline([e],{color:"red"}).addTo(i.map):i.polyline.addLatLng(e)}}function l(n){for(var e=i.polyline.getLatLngs(),o=0;o<e.length;o++)if(e[o].equals(n.latlng)){e.splice(o,1);break}this.remove(),i.polyline.remove(),i.polyline=L.polyline(e,{color:"red"}).addTo(i.map)}function r(){for(var n=0;n<i.markers.length;n++)i.markers[n].off("click",l),i.markers[n].remove();i.markers=[],null!==i.polyline&&(i.polyline.remove(),i.polyline=null)}function p(){r(),console.log("self.polygon",i.polygon);for(var n=0;n<i.polygon.length;n++)i.polygon[n].remove();i.polygon=[]}function u(o){f(function(){var n=d.normalize(o);p(),i.polygon=[];for(var e=0;e<n.length;e++)i.polygon.push(L.polygon(n[e].latLngs,{color:"red"}).addTo(i.map))})}n.addClass("ap-map-polygon"),i.elemMap=n.find(".map"),a.height=m.height,i.map=null,i.markers=[],i.polyline=null,i.polygon=[],i.fixedPolygons=[],m.init(i.elemMap[0]).then(function(n){i.map=n,i.map.on("click",o)}),a.finish=function(){if(null!==i.polyline){var n=i.polyline.getLatLngs();r(),null===t&&i.polygon.push(L.polygon(n,{color:"red"}).addTo(i.map));for(var e=[],o=0;o<i.polygon.length;o++)e.push(i.polygon[o].getLatLngs()[0]);null!==t&&e.push(n);var l=d.denormalize(e);g.$broadcast("ap-map:polygonpicker",a.name,l),null!==t&&t.$setViewValue(l)}},a.clear=p;var c=a.$on("apMap:showOnMapPolygon",function(n,e,o){a.name===e&&null!==o&&u(o)});null!==t&&a.$watch(function(){return t.$modelValue},function(n){n&&angular.isObject(n)&&u(n)}),a.$watch("fixedPolygons",function(o){f(function(){var n,e=d.normalize(o);for(n=0;n<i.fixedPolygons.length;n++)i.fixedPolygons[n].remove();for(i.fixedPolygons=[],n=0;n<e.length;n++)i.fixedPolygons.push(L.polygon(e[n].latLngs,{color:"blue"}).addTo(i.map))})});var s=a.$on("$destroy",function(){null!==i.map&&i.map.off("click",o),c(),s()})},templateUrl:"directives/mapPolygon/mapPolygon.template.html"}}]),angular.module("ap-maps").directive("apMapPolyline",["mapService","linestringNormalizer","$rootScope","$timeout",function(m,d,g,f){return{restrict:"AE",require:"?ngModel",scope:{name:"@"},link:function(l,n,e,o){var a=this;n.addClass("ap-map-polyline");var t=n.find(".map");function i(n){if(null!==a.map){var e=n.latlng,o=L.marker(e);o.addTo(a.map),o.on("click",r),a.markers.push(o),null===a.polyline?a.polyline=L.polyline([e],{color:"red"}).addTo(a.map):a.polyline.addLatLng(e)}}function r(n){var e=a.polyline.getLatLngs();console.log(a.polyline);for(var o=0;o<e.length;o++)if(e[o].equals(n.latlng)){e.splice(o,1);break}this.remove(),a.polyline.remove(),a.polyline=L.polyline(e,{color:"red"}).addTo(a.map)}function p(){console.log(a.markers);for(var n=0;n<a.markers.length;n++)a.markers[n].off("click",r),a.markers[n].remove();a.markers=[],null!==a.polyline&&(a.polyline.remove(),a.polyline=null)}function u(n){f(function(){p(),a.polyline=L.polyline(n.latLngs,{color:"red"}).addTo(a.map)})}l.height=m.height,a.map=null,a.markers=[],a.polyline=null,m.init(t[0]).then(function(n){a.map=n,a.map.on("click",i)}),l.finish=function(){if(null!==a.polyline){var n=a.polyline.getLatLngs();p(),a.polyline=L.polyline(n,{color:"red"}).addTo(a.map);var e=d.denormalize(n);g.$broadcast("ap-map:polylinepicker",l.name,n),null!==o&&o.$setViewValue(e)}},l.clear=p;var c=l.$on("apMap:showOnMapPolyline",function(n,e,o){console.log("entramos"),l.name===e&&null!==o&&u(o)});null!==o&&l.$watch(function(){return o.$modelValue},function(n){n&&angular.isObject(n)&&u(n)});var s=l.$on("$destroy",function(){null!==a.map&&a.map.off("click",i),c(),s()})},templateUrl:"directives/mapPolyline/mapPolyline.template.html"}}]),angular.module("ap-maps").directive("pointPicker",["$rootScope","$timeout",function(a,t){return{require:"ngModel",restrict:"AE",scope:{name:"@",ocultarBoton:"<"},link:function(r,n,e,p){var u=this;r.model={latitud:null,longitud:null},u.point=null;var o=r.$on("ap-map:pointpicker",function(n,e,o){r.name===e&&p.$setViewValue(o)});r.clickBtn=function(){e.view?(a.$broadcast("apBox:show",e.view),t(function(){a.$broadcast("apMap:showOnMapPoint",r.name,u.point)})):a.$broadcast("apMap:showOnMapPoint",r.name,u.point)},r.$watch(function(){return p.$modelValue},function(n){n&&(console.log(n),u.point=n,r.model.latitud=n.y,r.model.longitud=n.x)}),r.cambioCoordeandas=function(){var n=!1,e=!1;r.error=!1;for(var o=/^(([-])(\d)+((\.)(\d{2})(\d+)))$/,l=/^(([-])(\d)+((\.)(\d{2})(\d+)))$/,a=[",",":"," ","."],t=0;t<a.length;t++){var i=r.coordenadas.replace(/\s+/g,"").split(a[t]);2===i.length?(n=parseFloat(i[0].replace(",",".").match(o)),e=parseFloat(i[1].replace(",",".").match(l))):4===i.length&&(n=parseFloat((i[0]+"."+i[1]).match(o)),e=parseFloat((i[2]+"."+i[3]).match(l)))}if(!n||!e)return r.model.latitud="",r.model.longitud="",void(r.error=!0);r.model.latitud=n,r.model.longitud=e,p.$setViewValue({latitud:n,longitud:e}),u.point={x:e,y:n},p.$setViewValue(u.point),r.$emit("msfCoordenadas:change",this)};var l=r.$on("$destroy",function(){o(),l()})},templateUrl:"directives/pointPicker/pointPicker.template.html"}}]),angular.module("ap-maps").directive("polygonPicker",["$rootScope","$timeout",function(r,p){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(l,n,e,a){var o=this;o.polygon=null;var t=l.$on("ap-map:polygonpicker",function(n,e,o){l.name===e&&a.$setViewValue(o)});l.clickBtn=function(){e.view?(r.$broadcast("apBox:show",e.view),p(function(){r.$broadcast("apMap:showOnMapPolygon",l.name,o.polygon)})):r.$broadcast("apMap:showOnMapPolygon",l.name,o.polygon)},l.$watch(function(){return a.$modelValue},function(n){n&&(o.polygon=n)});var i=l.$on("$destroy",function(){t(),i()})},templateUrl:"directives/polygonPicker/polygonPicker.template.html"}}]),angular.module("ap-maps").directive("polylinePicker",["linestringNormalizer","$rootScope","$timeout",function(r,p,u){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(a,n,e,t){var o=null,l=a.$on("ap-map:polylinepicker",function(n,e,o){if(a.name===e){var l=r.denormalize(o);t.$setViewValue(l)}});a.clickBtn=function(){e.view?(p.$broadcast("apBox:show",e.view),u(function(){p.$broadcast("apMap:showOnMapPolyline",a.name,o)})):p.$broadcast("apMap:showOnMapPolyline",a.name,o)},a.$watch(function(){return t.$modelValue},function(n){n&&(o=r.normalize(n))});var i=a.$on("$destroy",function(){l(),i()})},templateUrl:"directives/polylinePicker/polylinePicker.template.html"}}]),angular.module("ap-maps").provider("MapsConfig",function(){var e=435,o=[-31.649913,-60.712328],l=13,a="OpenStreetMap.Mapnik";this.setMapHeight=function(n){return e=n,this},this.setCenter=function(n){return o=n,this},this.setZoom=function(n){return l=n,this},this.setTileProvider=function(n){return a=n,this},this.$get=[function(){return{defaultMapHeight:e,defaultCenter:o,defaultZoom:l,defaultTileProvider:a}}]}),angular.module("ap-maps").service("mapService",["MapsConfig","$timeout",function(o,n){return{height:o.defaultMapHeight,init:function(e){return n(function(){var n=L.map(e,{center:o.defaultCenter,zoom:o.defaultZoom},1e3);return L.tileLayer.provider(o.defaultTileProvider).addTo(n),n})}}}]),angular.module("ap-maps").service("linestringNormalizer",["pointNormalizer",function(a){this.normalize=function(n){var e,o,l=[];if(angular.isArray(n))for(e=0;e<n.length;e++)o=n[e],l.push(a.normalize(o));else if(n)for(e=0;e<n.points.length;e++)o=n.points[e],l.push(a.normalize(o));return{latLngs:l,closed:n.closed}},this.denormalize=function(n){for(var e=[],o=0;o<n.length;o++)e.push(a.denormalize(n[o]));return{points:e}}}]),angular.module("ap-maps").service("pointNormalizer",[function(){this.normalize=function(n){return angular.isArray(n)?L.latLng(n[1],n[0]):L.latLng(n.y,n.x)},this.denormalize=function(n){return{x:n.lng,y:n.lat}}}]),angular.module("ap-maps").service("polygonNormalizer",["linestringNormalizer",function(t){this.normalize=function(n){var e,o,l=[];if(angular.isArray(n))for(e=0;e<n.length;e++)o=n[e],l.push(t.normalize(o));else if(n)for(e=0;e<n.rings.length;e++)o=n.rings[e],l.push(t.normalize(o));return l},this.denormalize=function(n){for(var e=[],o=0;o<n.length;o++){var l=n[o],a=t.denormalize(l);a.points.push(a.points[0]),e.push(a)}return{rings:e}}}]),angular.module("adminPanel").run(["$templateCache",function(n){n.put("directives/mapPoint/mapPoint.template.html","<div class=map ng-style=\"{'height':height}\"></div>"),n.put("directives/mapPolygon/mapPolygon.template.html","<div class=map ng-style=\"{'height':height}\"></div><button type=button class=button ng-click=clear()>Limpiar</button><button type=button class=button ng-click=finish()>Terminar</button>"),n.put("directives/mapPolyline/mapPolyline.template.html","<div class=map ng-style=\"{'height':height}\"></div><button type=button class=button ng-click=clear()>Limpiar</button><button type=button class=button ng-click=finish()>Terminar</button>"),n.put("directives/pointPicker/pointPicker.template.html",'<div class="row column"><div class="callout secondary text-center">Podés obtener los datos de<u><a href=https://www.santafe.gov.ar/idesf/servicios/generador-de-coordenadas/tramite.php target=_blank>acá</a></u></div></div><div class="row column"><label ng-class="{\'is-invalid-label\':error}"><input style=margin-bottom:3px type=text ng-class="{\'is-invalid-input\':error}" ng-model=coordenadas ng-change=cambioCoordeandas()><span ng-class="{\'is-visible\':error}" style=margin-top:7px class=form-error>El campo ingresado contiene errores.</span></label></div><div class=row><div class="columns small-12 large-6"><label>Latitud <input type=text ng-value=model.latitud readonly></label></div><div class="columns small-12 large-6"><label>Longitud <input type=text ng-value=model.longitud readonly></label></div><div class="columns small-12 large-6" ng-if=!ocultarBoton><button type=button class=button ng-click=clickBtn()>Ver Punto en Mapa</button></div></div>'),n.put("directives/polygonPicker/polygonPicker.template.html",'<div class=row><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver en Mapa</button></div></div>'),n.put("directives/polylinePicker/polylinePicker.template.html",'<div class=row><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver en Mapa</button></div></div>')}]);