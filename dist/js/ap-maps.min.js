/*! ap-maps 2018-04-17 */

angular.module("ap-maps",["adminPanel"]),angular.module("ap-maps").directive("apMapPoint",["mapService","pointNormalizer","$rootScope","$timeout",function(c,m,s,n){return{restrict:"AE",require:"?ngModel",scope:{name:"@"},link:function(l,n,e,t){var o=!angular.isUndefined(e.readonly),a=this;function i(n){var e=m.normalize(n);a.point=e,null!==a.map&&(a.map.panTo(e),r(e))}function r(n){null!==a.marker&&(a.marker.remove(),a.marker=null),a.marker=L.marker([n.lat,n.lng]),a.marker.addTo(a.map)}function p(n){if(null!==a.map){var e=n.latlng;r(e);var o=m.denormalize(e);s.$broadcast("ap-map:pointpicker",l.name,o),null!==t&&t.$setViewValue(o)}}a.elemMap=n.find(".map"),l.height=c.height,a.map=null,a.marker=null,a.point=null,a.initPromise=c.init(a.elemMap[0]).then(function(n){a.map=n,o||a.map.on("click",p),null!==a.point&&(a.map.panTo(a.point),r(a.point))}),l.$on("apMap:showOnMapPoint",function(n,e,o){l.name===e&&null!==o&&i(o)}),null!==t&&l.$watch(function(){return t.$modelValue},function(n){n&&angular.isObject(n)&&i(n)});var u=l.$on("$destroy",function(){null!==a.map&&a.map.off("click",p),u()})},templateUrl:"directives/mapPoint/mapPoint.template.html"}}]),angular.module("ap-maps").directive("apMapPolygon",["mapService","polygonNormalizer","$rootScope","$timeout",function(s,d,g,f){return{restrict:"AE",require:"?ngModel",scope:{name:"@",fixedPolygons:"=?"},link:function(t,n,e,a){var i=this;function o(n){if(null!==i.map){var e=n.latlng,o=L.marker(e);o.addTo(i.map),o.on("click",l),i.markers.push(o),null===i.polyline?i.polyline=L.polyline([e],{color:"red"}).addTo(i.map):i.polyline.addLatLng(e)}}function l(n){for(var e=i.polyline.getLatLngs(),o=0;o<e.length;o++)if(e[o].equals(n.latlng)){e.splice(o,1);break}this.remove(),i.polyline.remove(),i.polyline=L.polyline(e,{color:"red"}).addTo(i.map)}function r(){for(var n=0;n<i.markers.length;n++)i.markers[n].off("click",l),i.markers[n].remove();i.markers=[],null!==i.polyline&&(i.polyline.remove(),i.polyline=null)}function p(){r(),console.log("self.polygon",i.polygon);for(var n=0;n<i.polygon.length;n++)i.polygon[n].remove();i.polygon=[]}function u(o){f(function(){var n=d.normalize(o);p(),i.polygon=[];for(var e=0;e<n.length;e++)i.polygon.push(L.polygon(n[e].latLngs,{color:"red"}).addTo(i.map))})}n.addClass("ap-map-polygon"),i.elemMap=n.find(".map"),t.height=s.height,i.map=null,i.markers=[],i.polyline=null,i.polygon=[],i.fixedPolygons=[],s.init(i.elemMap[0]).then(function(n){i.map=n,i.map.on("click",o)}),t.finish=function(){if(null!==i.polyline){var n=i.polyline.getLatLngs();r(),null===a&&i.polygon.push(L.polygon(n,{color:"red"}).addTo(i.map));for(var e=[],o=0;o<i.polygon.length;o++)e.push(i.polygon[o].getLatLngs()[0]);null!==a&&e.push(n);var l=d.denormalize(e);g.$broadcast("ap-map:polygonpicker",t.name,l),null!==a&&a.$setViewValue(l)}},t.clear=p;var c=t.$on("apMap:showOnMapPolygon",function(n,e,o){t.name===e&&null!==o&&u(o)});null!==a&&t.$watch(function(){return a.$modelValue},function(n){n&&angular.isObject(n)&&u(n)}),t.$watch("fixedPolygons",function(o){f(function(){var n,e=d.normalize(o);for(n=0;n<i.fixedPolygons.length;n++)i.fixedPolygons[n].remove();for(i.fixedPolygons=[],n=0;n<e.length;n++)i.fixedPolygons.push(L.polygon(e[n].latLngs,{color:"blue"}).addTo(i.map))})});var m=t.$on("$destroy",function(){null!==i.map&&i.map.off("click",o),c(),m()})},templateUrl:"directives/mapPolygon/mapPolygon.template.html"}}]),angular.module("ap-maps").directive("apMapPolyline",["mapService","$rootScope",function(s,d){return{restrict:"AE",scope:{name:"@"},link:function(l,n,e){var o=n.find(".map");l.height=s.height;var t=null,a=[],i=null;function r(n){if(null!==t){var e=n.latlng,o=L.marker(e);o.addTo(t),o.on("click",p),a.push(o),null===i?i=L.polyline([e],{color:"red"}).addTo(t):i.addLatLng(e)}}function p(n){for(var e=i.getLatLngs(),o=0;o<e.length;o++)if(e[o].equals(n.latlng)){e.splice(o,1);break}this.remove(),i.remove(),i=L.polyline(e,{color:"red"}).addTo(t)}function u(){console.log(a);for(var n=0;n<a.length;n++)a[n].off("click",p),a[n].remove();a=[],null!==i&&(i.remove(),i=null)}s.init(o[0]).then(function(n){(t=n).on("click",r)}),l.finish=function(){if(null!==i){var n=i.getLatLngs();u(),i=L.polyline(n,{color:"red"}).addTo(t),d.$broadcast("ap-map:polylinepicker",l.name,n)}},l.clear=u;var c=l.$on("apMap:showOnMapPolyline",function(n,e,o){l.name===e&&null!==o&&(u(),i=L.polyline(o.latLngs,{color:"red"}).addTo(t))}),m=l.$on("$destroy",function(){null!==t&&t.off("click",r),c(),m()})},templateUrl:"directives/mapPolyline/mapPolyline.template.html"}}]),angular.module("ap-maps").directive("pointPicker",["$rootScope","$timeout",function(r,p){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(l,n,e,t){var o=this;l.model={latitud:null,longitud:null},o.point=null;var a=l.$on("ap-map:pointpicker",function(n,e,o){l.name===e&&t.$setViewValue(o)});l.clickBtn=function(){e.view?(r.$broadcast("apBox:show",e.view),p(function(){r.$broadcast("apMap:showOnMapPoint",l.name,o.point)})):r.$broadcast("apMap:showOnMapPoint",l.name,o.point)},l.$watch(function(){return t.$modelValue},function(n){n&&(o.point=n,l.model.latitud=n.y,l.model.longitud=n.x)});var i=l.$on("$destroy",function(){a(),i()})},templateUrl:"directives/pointPicker/pointPicker.template.html"}}]),angular.module("ap-maps").directive("polygonPicker",["$rootScope","$timeout",function(r,p){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(l,n,e,t){var o=this;o.polygon=null;var a=l.$on("ap-map:polygonpicker",function(n,e,o){l.name===e&&t.$setViewValue(o)});l.clickBtn=function(){e.view?(r.$broadcast("apBox:show",e.view),p(function(){r.$broadcast("apMap:showOnMapPolygon",l.name,o.polygon)})):r.$broadcast("apMap:showOnMapPolygon",l.name,o.polygon)},l.$watch(function(){return t.$modelValue},function(n){n&&(o.polygon=n)});var i=l.$on("$destroy",function(){a(),i()})},templateUrl:"directives/polygonPicker/polygonPicker.template.html"}}]),angular.module("ap-maps").directive("polylinePicker",["linestringNormalizer","$rootScope",function(r,p){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(t,n,e,a){var o=null,l=t.$on("ap-map:polylinepicker",function(n,e,o){if(t.name===e){var l=r.denormalize(o);a.$setViewValue(l)}});t.clickBtn=function(){e.view&&p.$broadcast("apBox:show",e.view),p.$broadcast("apMap:showOnMapPolyline",t.name,o)},t.$watch(function(){return a.$modelValue},function(n){n&&(o=r.normalize(n))});var i=t.$on("$destroy",function(){l(),i()})},templateUrl:"directives/polylinePicker/polylinePicker.template.html"}}]),angular.module("ap-maps").provider("MapsConfig",function(){var e=435,o=[-31.649913,-60.712328],l=13,t="OpenStreetMap.Mapnik";this.setMapHeight=function(n){return e=n,this},this.setCenter=function(n){return o=n,this},this.setZoom=function(n){return l=n,this},this.setTileProvider=function(n){return t=n,this},this.$get=[function(){return{defaultMapHeight:e,defaultCenter:o,defaultZoom:l,defaultTileProvider:t}}]}),angular.module("ap-maps").service("mapService",["MapsConfig","$timeout",function(o,n){return{height:o.defaultMapHeight,init:function(e){return n(function(){var n=L.map(e,{center:o.defaultCenter,zoom:o.defaultZoom},1e3);return L.tileLayer.provider(o.defaultTileProvider).addTo(n),n})}}}]),angular.module("ap-maps").service("linestringNormalizer",["pointNormalizer",function(t){this.normalize=function(n){var e,o,l=[];if(angular.isArray(n))for(e=0;e<n.length;e++)o=n[e],l.push(t.normalize(o));else if(n)for(e=0;e<n.points.length;e++)o=n.points[e],l.push(t.normalize(o));return{latLngs:l,closed:n.closed}},this.denormalize=function(n){for(var e=[],o=0;o<n.length;o++)e.push(t.denormalize(n[o]));return{points:e}}}]),angular.module("ap-maps").service("pointNormalizer",[function(){this.normalize=function(n){return angular.isArray(n)?L.latLng(n[1],n[0]):L.latLng(n.y,n.x)},this.denormalize=function(n){return{x:n.lng,y:n.lat}}}]),angular.module("ap-maps").service("polygonNormalizer",["linestringNormalizer",function(a){this.normalize=function(n){var e,o,l=[];if(angular.isArray(n))for(e=0;e<n.length;e++)o=n[e],l.push(a.normalize(o));else if(n)for(e=0;e<n.rings.length;e++)o=n.rings[e],l.push(a.normalize(o));return l},this.denormalize=function(n){for(var e=[],o=0;o<n.length;o++){var l=n[o],t=a.denormalize(l);t.points.push(t.points[0]),e.push(t)}return{rings:e}}}]),angular.module("adminPanel").run(["$templateCache",function(n){n.put("directives/mapPoint/mapPoint.template.html","<div class=map ng-style=\"{'height':height}\"></div>"),n.put("directives/mapPolygon/mapPolygon.template.html","<div class=map ng-style=\"{'height':height}\"></div><button type=button class=button ng-click=clear()>Limpiar</button><button type=button class=button ng-click=finish()>Terminar</button>"),n.put("directives/mapPolyline/mapPolyline.template.html","<div class=map ng-style=\"{'height':height}\"></div><button type=button class=button ng-click=clear()>Limpiar</button><button type=button class=button ng-click=finish()>Terminar</button>"),n.put("directives/pointPicker/pointPicker.template.html",'<div class=row><div class="columns small-12 large-6"><label>Latitud <input type=text ng-value=model.latitud readonly></label></div><div class="columns small-12 large-6"><label>Longitud <input type=text ng-value=model.longitud readonly></label></div><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver Punto en Mapa</button></div></div>'),n.put("directives/polygonPicker/polygonPicker.template.html",'<div class=row><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver en Mapa</button></div></div>'),n.put("directives/polylinePicker/polylinePicker.template.html",'<div class=row><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver en Mapa</button></div></div>')}]);